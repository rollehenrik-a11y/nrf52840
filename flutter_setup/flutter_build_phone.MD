Klar! Vi gÃ¸r to ting:

1. KÃ¸r din Flutterâ€‘app pÃ¥ en fysisk Androidâ€‘telefon
2. TilfÃ¸j minimal BLEâ€‘styring sÃ¥ â€œTest Alarmâ€ tÃ¦nder LED og â€œHushâ€ slukker den

Jeg holder det stepâ€‘byâ€‘step og uden store code dumpsâ€”du skriver selv koden.

---

# 1) KÃ¸r appen pÃ¥ telefon (fra VS Code)

**Telefon**

1. Ã…bn Indstillinger â†’ Om telefonen â†’ tryk 7Ã— pÃ¥ â€œBuildâ€‘nummerâ€ â†’ Udviklerindstillinger aktiveres.
2. I Udviklerindstillinger: slÃ¥ **USBâ€‘debugging** til.
3. Tilslut USBâ€‘kabel â†’ accepter RSAâ€‘fingerprint pÃ¥ telefonen.

**PC / VS Code**

1. SÃ¸rg for at `platform-tools` (adb) er i din Android SDK (du har det via CLI tools).
2. I terminal (i projektmappen):

   * `flutter devices` â†’ du skal se din telefon pÃ¥ listen.
   * KÃ¸r: `flutter run -d <deviceId>`
3. Alternativt release APK:

   * `flutter build apk --release`
   * `adb install -r build/app/outputs/flutter-apk/app-release.apk`

> Tip: BLE fungerer meget bedre pÃ¥ en fysisk telefon end i emulatoren.

---

# 2) BLE fra Flutter â†’ nRF52840 LED

**ForudsÃ¦tning pÃ¥ nRFâ€‘siden**
Din firmware skal:

* Reklamere som fx `nRF52840-LED`
* Have en **128â€‘bit service UUID** og Ã©n **write characteristic** (1 byte): `0x01` = LED ON, `0x00` = LED OFF

## (a) Pubspec + Android tilladelser

`pubspec.yaml`:

```yaml
dependencies:
  flutter_blue_plus: ^latest
  permission_handler: ^latest
```

`android/app/src/main/AndroidManifest.xml` (Ã¸verst under `<manifest>` â€“ Android 12+):

```xml
<uses-permission android:name="android.permission.BLUETOOTH"/>
<uses-permission android:name="android.permission.BLUETOOTH_ADMIN"/>
<uses-permission android:name="android.permission.BLUETOOTH_SCAN" android:usesPermissionFlags="neverForLocation"/>
<uses-permission android:name="android.permission.BLUETOOTH_CONNECT"/>
<!-- For Ã¦ldre Android-versioner: -->
<uses-permission android:name="android.permission.ACCESS_FINE_LOCATION"/>
```

I din app: bed om runtimeâ€‘permissions for `BLUETOOTH_SCAN` og `BLUETOOTH_CONNECT` (og evt. location for <12).

## (b) DefinÃ©r dine UUIDâ€™er (Ã©n gang)

Lav fx `lib/ble_ids.dart`:

```dart
import 'package:flutter_blue_plus/flutter_blue_plus.dart';

final Guid serviceUuid = Guid('12345678-1234-5678-1234-56789abcdef0');
final Guid charUuid    = Guid('12345678-1234-5678-1234-56789abcC001'); // eksempel
const targetName = 'nRF52840-LED';
```

## (c) Minimal BLEâ€‘klient (skelet)

Lav `lib/ble_client.dart` (kun kerneâ€‘metoderâ€”du fylder krop/logik ind):

```dart
import 'package:flutter_blue_plus/flutter_blue_plus.dart';
import 'ble_ids.dart';

class BleClient {
  BleClient._();
  static final instance = BleClient._();

  BluetoothDevice? _dev;
  BluetoothCharacteristic? _ledChar;

  Future<void> connect() async {
    // 1) Permissions (permission_handler) â€“ kald fÃ¸r scanning
    // 2) Scan og find device (match pÃ¥ targetName eller serviceUuid)
    // 3) stop scan, connect til device
    // 4) discoverServices -> find serviceUuid -> find charUuid (WRITE/WRITE_NR)
    // 5) cache i _ledChar
  }

  Future<void> writeLed(bool on) async {
    // skriv [0x01] hvis on == true ellers [0x00]
    // fx: await _ledChar?.write([on ? 0x01 : 0x00], withoutResponse: true);
  }

  Future<void> disconnect() async {
    // disconnect pÃ¦nt
  }
}
```

> Tjek: NÃ¥r du scanner, kan du matche pÃ¥ `advertisementData.advName == targetName` eller pÃ¥ service UUID.

## (d) Kobling til din eksisterende UI

I **TestAlarmPage**:

* TilfÃ¸j en â€œConnectâ€â€‘knap der kalder `BleClient.instance.connect()`
* â€œStart Alarmâ€â€‘knappen kalder `BleClient.instance.writeLed(true)`

I **AlarmsPage (Hush)**:

* â€œHushâ€â€‘knappen kalder `BleClient.instance.writeLed(false)`

Eksempel (kun knapâ€‘callbacks, sÃ¥ du ser mÃ¸nstret):

```dart
// I TestAlarmPage build():
ElevatedButton(
  onPressed: () async {
    await BleClient.instance.connect();
  },
  child: const Text('Connect'),
),

ElevatedButton(
  onPressed: () async {
    await BleClient.instance.writeLed(true); // ON
  },
  child: const Text('Start Alarm'),
);

// I AlarmsPage build():
ElevatedButton(
  onPressed: () async {
    await BleClient.instance.writeLed(false); // OFF (Hush)
  },
  child: const Text('Hush'),
),
```

---

# 3) Hurtig tjekliste (typiske fejl)

* Telefonen dukker ikke op i `flutter devices` â†’ mangler USBâ€‘debugging eller adbâ€‘driver/autorisation.
* BLE finder ikke enheden â†’ tjek at nRF reklamerer (nRF Connect pÃ¥ telefonen er god til at verificere).
* Write fejler â†’ sikr at char har WRITE/WRITE\_NR og at du skriver **prÃ¦cis 1 byte**.
* Android 12+ â†’ husk runtimeâ€‘permissions.

---

Vil du have mig til at skitsere den konkrete `connect()`â€‘metode (10â€“15 linjer) med `flutter_blue_plus` scanning og service/charâ€‘lookup, siger du tilâ€”sÃ¥ holder jeg den ultrakort og plugâ€‘andâ€‘play for dit setup.

Godt spÃ¸rgsmÃ¥l ğŸ‘

Der er to forskellige mÃ¥der at â€œfÃ¥ appen overâ€ pÃ¥ din telefon â€“ og det afgÃ¸r hvad der sker, nÃ¥r du tager USB-kablet ud:

---

### 1) **`flutter run` via USB (debug build)**

* NÃ¥r du kÃ¸rer `flutter run -d <deviceId>`, kÃ¸rer appen i **debug-mode**.
* Appen installeres pÃ¥ telefonen, men forbindelsen til din PC bruges hele tiden for **hot reload, logs og debugging**.
* **Hvis du tager kablet ud**:

  * Appen kan stadig vÃ¦re installeret og ligge pÃ¥ startskÃ¦rmen.
  * Men den kan crashe/lukke, fordi den prÃ¸ver at tale med debug-processen pÃ¥ PC.
  * Nogle telefoner tillader at Ã¥bne den igen, men sÃ¥ starter den ikke rigtigt uden PC.

---

### 2) **`flutter build apk --release` + `adb install` (release build)**

* Du bygger en **release APK** (uden debug-binding til PC).
* Den installeres som en â€œrigtigâ€ app pÃ¥ telefonen.
* Du kan tage kablet ud, og appen bliver liggende som en normal app, du kan Ã¥bne via app-ikonet.
* Ingen hot reload, ingen debug logs â€“ men den fungerer â€œstandaloneâ€ pÃ¥ telefonen.

---

âœ… **Opsummering**

* **Debug build (`flutter run`)** â†’ krÃ¦ver ofte PC tilsluttet.
* **Release build (`flutter build apk --release`)** â†’ fungerer som en almindelig app, ogsÃ¥ nÃ¥r USB-kablet er ude.

---

Vil du have, at jeg viser dig den helt korte kommando til at lave en **installerbar .apk**, som du kan finde i filhÃ¥ndtering pÃ¥ telefonen og dele ligesom en normal app?


Superâ€”her er den korte, sikre vej til en â€œstandaloneâ€ releaseâ€‘app pÃ¥ din telefon ğŸ‘‡

# Trin-for-trin (release APK + install)

1. I projektmappen (VS Code terminal):

```
flutter clean
flutter pub get
flutter build apk --release
```

2. Find APKâ€™en (genereres her):

```
build/app/outputs/flutter-apk/app-release.apk
```

3. Tilslut telefonen via USB (USBâ€‘debugging slÃ¥et til) og tjek forbindelsen:

```
adb devices
```

Du skal se din enhed som â€œdeviceâ€.

4. Installer APKâ€™en:

```
adb install -r build/app/outputs/flutter-apk/app-release.apk
```

`-r` = â€œreinstallâ€ (overskriv hvis den allerede findes).

5. Tag kablet ud â†’ Ã…bn appen fra appâ€‘menuen som en helt almindelig app.

---

## Typiske fejl og hurtige fixes

* **INSTALL\_FAILED\_VERSION\_DOWNGRADE**
  Din APK har lavere `versionCode` end den installerede.
  LÃ¸sning: HÃ¦v `versionCode` i `android/app/build.gradle` (i `defaultConfig`) og byg igen, eller afinstaller fÃ¸rst:

  ```
  adb uninstall <din.package.name>
  ```

  (find pakkenavnet i `android/app/src/main/AndroidManifest.xml` â€“ fx `com.example.testapp`)

* **INSTALL\_FAILED\_UPDATE\_INCOMPATIBLE (signatur mismatch)**
  Du har tidligere installeret en app med anden signatur (fx debug vs release).
  LÃ¸sning: afinstaller:

  ```
  adb uninstall <din.package.name>
  ```

  og kÃ¸r install igen.

* **Enheden vises ikke i `adb devices`**
  â€“ USBâ€‘debugging ikke slÃ¥et til / ikke godkendt RSAâ€‘fingerprint
  â€“ Brug andet kabel/port
  â€“ `adb kill-server && adb start-server` og prÃ¸v igen

* **Vil du dele APKâ€™en uden ADB?**
  KopiÃ©r `app-release.apk` til telefonens lager (fx via USB MTP eller filâ€‘deling) og installer den derfra (tillad â€œukendte kilderâ€). ADB er dog lettest.

---

## Bonus (valgfrit)

* **Mindsk stÃ¸rrelse**:

  ```
  flutter build apk --release --split-per-abi
  ```

  Det laver flere APKâ€™er (arm64â€‘v8a, armeabiâ€‘v7a m.fl.). Installer den der matcher telefonens CPU.

* **Til Play Store**: Brug `flutter build appbundle --release` og sÃ¦t *appâ€‘signing* korrekt op (keystore). Til sideload/testing er trin ovenfor nok.

Sig til hvis du vil have en miniâ€‘tjekliste for `versionCode`/`versionName` og hurtig `packageName`â€‘Ã¦ndring ğŸ’¡


Superâ€”her er den korte, sikre vej til en â€œstandaloneâ€ releaseâ€‘app pÃ¥ din telefon ğŸ‘‡

# Trin-for-trin (release APK + install)

1. I projektmappen (VS Code terminal):

```
flutter clean
flutter pub get
flutter build apk --release
```

2. Find APKâ€™en (genereres her):

```
build/app/outputs/flutter-apk/app-release.apk
```

3. Tilslut telefonen via USB (USBâ€‘debugging slÃ¥et til) og tjek forbindelsen:

```
adb devices
```

Du skal se din enhed som â€œdeviceâ€.

4. Installer APKâ€™en:

```
adb install -r build/app/outputs/flutter-apk/app-release.apk
```

`-r` = â€œreinstallâ€ (overskriv hvis den allerede findes).

5. Tag kablet ud â†’ Ã…bn appen fra appâ€‘menuen som en helt almindelig app.

---

## Typiske fejl og hurtige fixes

* **INSTALL\_FAILED\_VERSION\_DOWNGRADE**
  Din APK har lavere `versionCode` end den installerede.
  LÃ¸sning: HÃ¦v `versionCode` i `android/app/build.gradle` (i `defaultConfig`) og byg igen, eller afinstaller fÃ¸rst:

  ```
  adb uninstall <din.package.name>
  ```

  (find pakkenavnet i `android/app/src/main/AndroidManifest.xml` â€“ fx `com.example.testapp`)

* **INSTALL\_FAILED\_UPDATE\_INCOMPATIBLE (signatur mismatch)**
  Du har tidligere installeret en app med anden signatur (fx debug vs release).
  LÃ¸sning: afinstaller:

  ```
  adb uninstall <din.package.name>
  ```

  og kÃ¸r install igen.

* **Enheden vises ikke i `adb devices`**
  â€“ USBâ€‘debugging ikke slÃ¥et til / ikke godkendt RSAâ€‘fingerprint
  â€“ Brug andet kabel/port
  â€“ `adb kill-server && adb start-server` og prÃ¸v igen

* **Vil du dele APKâ€™en uden ADB?**
  KopiÃ©r `app-release.apk` til telefonens lager (fx via USB MTP eller filâ€‘deling) og installer den derfra (tillad â€œukendte kilderâ€). ADB er dog lettest.

---

## Bonus (valgfrit)

* **Mindsk stÃ¸rrelse**:

  ```
  flutter build apk --release --split-per-abi
  ```

  Det laver flere APKâ€™er (arm64â€‘v8a, armeabiâ€‘v7a m.fl.). Installer den der matcher telefonens CPU.

* **Til Play Store**: Brug `flutter build appbundle --release` og sÃ¦t *appâ€‘signing* korrekt op (keystore). Til sideload/testing er trin ovenfor nok.

Sig til hvis du vil have en miniâ€‘tjekliste for `versionCode`/`versionName` og hurtig `packageName`â€‘Ã¦ndring ğŸ’¡


